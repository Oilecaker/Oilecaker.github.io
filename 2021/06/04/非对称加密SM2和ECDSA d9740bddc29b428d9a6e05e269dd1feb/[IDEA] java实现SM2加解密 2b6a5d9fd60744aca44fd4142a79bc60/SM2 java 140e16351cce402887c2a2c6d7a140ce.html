<h1 id="SM2-java"><a href="#SM2-java" class="headerlink" title="SM2.java"></a>SM2.java</h1><pre><code class="java"><span class="keyword">package</span> SM2;

<span class="keyword">import</span> java.math.BigInteger;
<span class="keyword">import</span> java.security.SecureRandom;
<span class="keyword">import</span> java.util.Arrays;

<span class="keyword">import</span> org.bouncycastle.crypto.DerivationFunction;
<span class="keyword">import</span> org.bouncycastle.crypto.digests.SHA256Digest;
<span class="keyword">import</span> org.bouncycastle.crypto.digests.ShortenedDigest;
<span class="keyword">import</span> org.bouncycastle.crypto.generators.KDF1BytesGenerator;
<span class="keyword">import</span> org.bouncycastle.crypto.params.ISO18033KDFParameters;
<span class="keyword">import</span> org.bouncycastle.math.ec.ECCurve;
<span class="keyword">import</span> org.bouncycastle.math.ec.ECPoint;

<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SM2</span> </span>{

    <span class="comment">/** 素数p */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger p = <span class="keyword">new</span> BigInteger(<span class="string">"FFFFFFFE"</span> + <span class="string">"FFFFFFFF"</span>
            + <span class="string">"FFFFFFFF"</span> + <span class="string">"FFFFFFFF"</span> + <span class="string">"FFFFFFFF"</span> + <span class="string">"00000000"</span> + <span class="string">"FFFFFFFF"</span>
            + <span class="string">"FFFFFFFF"</span>, <span class="number">16</span>);

    <span class="comment">/** 系数a */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger a = <span class="keyword">new</span> BigInteger(<span class="string">"FFFFFFFE"</span> + <span class="string">"FFFFFFFF"</span>
            + <span class="string">"FFFFFFFF"</span> + <span class="string">"FFFFFFFF"</span> + <span class="string">"FFFFFFFF"</span> + <span class="string">"00000000"</span> + <span class="string">"FFFFFFFF"</span>
            + <span class="string">"FFFFFFFC"</span>, <span class="number">16</span>);

    <span class="comment">/** 系数b */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger b = <span class="keyword">new</span> BigInteger(<span class="string">"28E9FA9E"</span> + <span class="string">"9D9F5E34"</span>
            + <span class="string">"4D5A9E4B"</span> + <span class="string">"CF6509A7"</span> + <span class="string">"F39789F5"</span> + <span class="string">"15AB8F92"</span> + <span class="string">"DDBCBD41"</span>
            + <span class="string">"4D940E93"</span>, <span class="number">16</span>);

    <span class="comment">/** 坐标x */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger xg = <span class="keyword">new</span> BigInteger(<span class="string">"32C4AE2C"</span> + <span class="string">"1F198119"</span>
            + <span class="string">"5F990446"</span> + <span class="string">"6A39C994"</span> + <span class="string">"8FE30BBF"</span> + <span class="string">"F2660BE1"</span> + <span class="string">"715A4589"</span>
            + <span class="string">"334C74C7"</span>, <span class="number">16</span>);

    <span class="comment">/** 坐标y */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger yg = <span class="keyword">new</span> BigInteger(<span class="string">"BC3736A2"</span> + <span class="string">"F4F6779C"</span>
            + <span class="string">"59BDCEE3"</span> + <span class="string">"6B692153"</span> + <span class="string">"D0A9877C"</span> + <span class="string">"C62A4740"</span> + <span class="string">"02DF32E5"</span>
            + <span class="string">"2139F0A0"</span>, <span class="number">16</span>);

    <span class="comment">/** 基点G, G=(xg,yg),其介记为n */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BigInteger n = <span class="keyword">new</span> BigInteger(<span class="string">"FFFFFFFE"</span> + <span class="string">"FFFFFFFF"</span>
            + <span class="string">"FFFFFFFF"</span> + <span class="string">"FFFFFFFF"</span> + <span class="string">"7203DF6B"</span> + <span class="string">"21C6052B"</span> + <span class="string">"53BBF409"</span>
            + <span class="string">"39D54123"</span>, <span class="number">16</span>);

    <span class="keyword">private</span> <span class="keyword">static</span> SecureRandom random = <span class="keyword">new</span> SecureRandom();
    <span class="keyword">private</span> ECCurve.Fp curve;
    <span class="keyword">private</span> ECPoint G;

    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">printHexString</span><span class="params">(<span class="keyword">byte</span>[] b)</span> </span>{
        StringBuilder builder = <span class="keyword">new</span> StringBuilder();
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; b.length; i++) {
            String hex = Integer.toHexString(b[i] &amp; <span class="number">0xFF</span>);
            <span class="keyword">if</span> (hex.length() == <span class="number">1</span>) {
                builder.append(<span class="string">'0'</span>+hex);
                hex = <span class="string">'0'</span> + hex;
            }
            <span class="comment">//            System.out.print(hex.toUpperCase());</span>
            System.out.print(hex.toUpperCase());
            builder.append(hex);
        }
        System.out.println();
        <span class="keyword">return</span> builder.toString();
    }

    <span class="function"><span class="keyword">public</span> BigInteger <span class="title">random</span><span class="params">(BigInteger max)</span> </span>{
        BigInteger r = <span class="keyword">new</span> BigInteger(<span class="number">256</span>, random);
        <span class="comment">// int count = 1;</span>
        <span class="keyword">while</span> (r.compareTo(max) &gt;= <span class="number">0</span>) {
            r = <span class="keyword">new</span> BigInteger(<span class="number">128</span>, random);
            <span class="comment">// count++;</span>
        }
        <span class="comment">// System.out.println("count: " + count);</span>
        <span class="keyword">return</span> r;
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">allZero</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> </span>{
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; buffer.length; i++) {
            <span class="keyword">if</span> (buffer[i] != <span class="number">0</span>)
                <span class="keyword">return</span> <span class="keyword">false</span>;
        }
        <span class="keyword">return</span> <span class="keyword">true</span>;
    }

    <span class="comment">/**</span>
<span class="comment">     * 加密</span>
<span class="comment">     * <span class="doctag">@param</span> input 待加密消息M</span>
<span class="comment">     * <span class="doctag">@param</span> publicKey 公钥</span>
<span class="comment">     * <span class="doctag">@return</span> byte[] 加密后的字节数组</span>
<span class="comment">     */</span>
    <span class="keyword">public</span> <span class="keyword">byte</span>[] encrypt(String input, ECPoint publicKey) {
        System.out.println(<span class="string">"---加密---"</span>);

        System.out.println(<span class="string">"publicKey is: "</span>+publicKey);

        <span class="keyword">byte</span>[] inputBuffer = input.getBytes();
        printHexString(inputBuffer);

        <span class="comment">/* 1 产生随机数k，k属于[1, n-1] */</span>
        BigInteger k = random(n);
        System.out.print(<span class="string">"随机数k: "</span>);
        printHexString(k.toByteArray());

        <span class="comment">/* 2 计算椭圆曲线点C1 = [k]G = (x1, y1) */</span>
        ECPoint C1 = G.multiply(k);
        <span class="keyword">byte</span>[] C1Buffer = C1.getEncoded(<span class="keyword">false</span>);
        System.out.print(<span class="string">"椭圆曲线点C1: "</span>);
        printHexString(C1Buffer);

        <span class="comment">// 3 计算椭圆曲线点 S = [h]Pb * curve没有指定余因子，h为空</span>

        <span class="comment">//             BigInteger h = curve.getCofactor(); System.out.print("h: ");</span>
        <span class="comment">//             printHexString(h.toByteArray()); if (publicKey != null) { ECPoint</span>
        <span class="comment">//             result = publicKey.multiply(h); if (!result.isInfinity()) {</span>
        <span class="comment">//             System.out.println("pass"); } else {</span>
        <span class="comment">//            System.err.println("计算椭圆曲线点 S = [h]Pb失败"); return null; } }</span>

        <span class="comment">/* 4 计算 [k]PB = (x2, y2) */</span>
        ECPoint kpb = publicKey.multiply(k).normalize();

        <span class="comment">/* 5 计算 t = KDF(x2||y2, klen) */</span>
        <span class="keyword">byte</span>[] kpbBytes = kpb.getEncoded(<span class="keyword">false</span>);
        DerivationFunction kdf = <span class="keyword">new</span> KDF1BytesGenerator(<span class="keyword">new</span> ShortenedDigest(
                <span class="keyword">new</span> SHA256Digest(), <span class="number">20</span>));
        <span class="keyword">byte</span>[] t = <span class="keyword">new</span> <span class="keyword">byte</span>[inputBuffer.length];
        kdf.init(<span class="keyword">new</span> ISO18033KDFParameters(kpbBytes));
        kdf.generateBytes(t, <span class="number">0</span>, t.length);

        <span class="keyword">if</span> (allZero(t)) {
            System.err.println(<span class="string">"all zero"</span>);
        }

        <span class="comment">/* 6 计算C2=M^t */</span>
        <span class="keyword">byte</span>[] C2 = <span class="keyword">new</span> <span class="keyword">byte</span>[inputBuffer.length];
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inputBuffer.length; i++) {
            C2[i] = (<span class="keyword">byte</span>) (inputBuffer[i] ^ t[i]);
        }

        <span class="comment">/* 7 计算C3 = Hash(x2 || M || y2) */</span>
        <span class="keyword">byte</span>[] C3 = calculateHash(kpb.getXCoord().toBigInteger(), inputBuffer,
                kpb.getYCoord().toBigInteger());

        <span class="comment">/* 8 输出密文 C=C1 || C2 || C3 */</span>
        <span class="keyword">byte</span>[] encryptResult = <span class="keyword">new</span> <span class="keyword">byte</span>[C1Buffer.length + C2.length + C3.length];
        System.arraycopy(C1Buffer, <span class="number">0</span>, encryptResult, <span class="number">0</span>, C1Buffer.length);
        System.arraycopy(C2, <span class="number">0</span>, encryptResult, C1Buffer.length, C2.length);
        System.arraycopy(C3, <span class="number">0</span>, encryptResult, C1Buffer.length + C2.length,
                C3.length);

        System.out.print(<span class="string">"密文: "</span>);
        printHexString(encryptResult);

        <span class="keyword">return</span> encryptResult;
    }

    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] encryptData, BigInteger privateKey)</span> </span>{
        System.out.println(<span class="string">"-----解密-----"</span>);
        System.out.println(<span class="string">"privateKey is: "</span>+privateKey);
        System.out.println(<span class="string">"encryptData length: "</span> + encryptData.length);

        <span class="keyword">byte</span>[] C1Byte = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">65</span>];
        System.arraycopy(encryptData, <span class="number">0</span>, C1Byte, <span class="number">0</span>, C1Byte.length);

        ECPoint C1 = curve.decodePoint(C1Byte).normalize();

        <span class="comment">/* 计算[dB]C1 = (x2, y2) */</span>
        ECPoint dBC1 = C1.multiply(privateKey).normalize();

        <span class="comment">/* 计算t = KDF(x2 || y2, klen) */</span>
        <span class="keyword">byte</span>[] dBC1Bytes = dBC1.getEncoded(<span class="keyword">false</span>);
        DerivationFunction kdf = <span class="keyword">new</span> KDF1BytesGenerator(<span class="keyword">new</span> ShortenedDigest(
                <span class="keyword">new</span> SHA256Digest(), <span class="number">20</span>));

        <span class="keyword">int</span> klen = encryptData.length - <span class="number">65</span> - <span class="number">20</span>;
        System.out.println(<span class="string">"klen = "</span> + klen);

        <span class="keyword">byte</span>[] t = <span class="keyword">new</span> <span class="keyword">byte</span>[klen];
        kdf.init(<span class="keyword">new</span> ISO18033KDFParameters(dBC1Bytes));
        kdf.generateBytes(t, <span class="number">0</span>, t.length);

        <span class="keyword">if</span> (allZero(t)) {
            System.err.println(<span class="string">"all zero"</span>);
        }

        <span class="comment">/* 5 计算M'=C2^t */</span>
        <span class="keyword">byte</span>[] M = <span class="keyword">new</span> <span class="keyword">byte</span>[klen];
        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; M.length; i++) {
            M[i] = (<span class="keyword">byte</span>) (encryptData[C1Byte.length + i] ^ t[i]);
        }

        <span class="comment">/* 6 计算 u = Hash(x2 || M' || y2) 判断 u == C3是否成立 */</span>
        <span class="keyword">byte</span>[] C3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">20</span>];
        System.arraycopy(encryptData, encryptData.length - <span class="number">20</span>, C3, <span class="number">0</span>, <span class="number">20</span>);
        <span class="keyword">byte</span>[] u = calculateHash(dBC1.getXCoord().toBigInteger(), M, dBC1
                .getYCoord().toBigInteger());
        <span class="keyword">if</span> (Arrays.equals(u, C3)) {
            System.out.println(<span class="string">"解密成功"</span>);
            System.out.println(<span class="string">"元信息 = "</span> + <span class="keyword">new</span> String(M));
        } <span class="keyword">else</span> {
            System.out.print(<span class="string">"u = "</span>);
            printHexString(u);
            System.out.print(<span class="string">"C3 = "</span>);
            printHexString(C3);
            System.err.println(<span class="string">"解密验证失败"</span>);
        }
    }

    <span class="keyword">private</span> <span class="keyword">byte</span>[] calculateHash(BigInteger x2, <span class="keyword">byte</span>[] M, BigInteger y2) {
        ShortenedDigest digest = <span class="keyword">new</span> ShortenedDigest(<span class="keyword">new</span> SHA256Digest(), <span class="number">20</span>);
        <span class="keyword">byte</span>[] buf = x2.toByteArray();
        digest.update(buf, <span class="number">0</span>, buf.length);
        digest.update(M, <span class="number">0</span>, M.length);
        buf = y2.toByteArray();
        digest.update(buf, <span class="number">0</span>, buf.length);

        buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">20</span>];
        digest.doFinal(buf, <span class="number">0</span>);
        <span class="keyword">return</span> buf;
    }

    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">between</span><span class="params">(BigInteger param, BigInteger min, BigInteger max)</span> </span>{
        <span class="keyword">if</span> (param.compareTo(min) &gt;= <span class="number">0</span> &amp;&amp; param.compareTo(max) &lt; <span class="number">0</span>) {
            <span class="keyword">return</span> <span class="keyword">true</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }
    }

    <span class="comment">/**</span>
<span class="comment">     * 公钥校验</span>
<span class="comment">     * <span class="doctag">@param</span> publicKey 公钥</span>
<span class="comment">     * <span class="doctag">@return</span> boolean true或false</span>
<span class="comment">     */</span>
    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkPublicKey</span><span class="params">(ECPoint publicKey)</span> </span>{
        <span class="keyword">if</span> (!publicKey.isInfinity()) {
            BigInteger x = publicKey.getXCoord().toBigInteger();
            BigInteger y = publicKey.getYCoord().toBigInteger();
            <span class="keyword">if</span> (between(x, <span class="keyword">new</span> BigInteger(<span class="string">"0"</span>), p) &amp;&amp; between(y, <span class="keyword">new</span> BigInteger(<span class="string">"0"</span>), p)) {
                BigInteger xResult = x.pow(<span class="number">3</span>).add(a.multiply(x)).add(b).mod(p);
                System.out.println(<span class="string">"xResult: "</span> + xResult.toString());
                BigInteger yResult = y.pow(<span class="number">2</span>).mod(p);
                System.out.println(<span class="string">"yResult: "</span> + yResult.toString());
                <span class="keyword">if</span> (yResult.equals(xResult) &amp;&amp; publicKey.multiply(n).isInfinity()) {
                    <span class="keyword">return</span> <span class="keyword">true</span>;
                }
            }
            <span class="keyword">return</span> <span class="keyword">false</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> <span class="keyword">false</span>;
        }
    }

    <span class="comment">/**</span>
<span class="comment">     * 获得公私钥对</span>
<span class="comment">     * <span class="doctag">@return</span></span>
<span class="comment">     */</span>
    <span class="function"><span class="keyword">public</span> SM2KeyPair <span class="title">generateKeyPair</span><span class="params">()</span> </span>{
        BigInteger d = random(n.subtract(<span class="keyword">new</span> BigInteger(<span class="string">"1"</span>)));
        SM2KeyPair keyPair = <span class="keyword">new</span> SM2KeyPair(G.multiply(d).normalize(), d);
        <span class="keyword">if</span> (checkPublicKey(keyPair.getPublicKey())) {
            System.out.println(<span class="string">"generate key successfully"</span>);
            <span class="keyword">return</span> keyPair;
        } <span class="keyword">else</span> {
            System.err.println(<span class="string">"generate key failed"</span>);
            <span class="keyword">return</span> <span class="keyword">null</span>;
        }
    }

    <span class="function"><span class="keyword">public</span> <span class="title">SM2</span><span class="params">()</span> </span>{
        curve = <span class="keyword">new</span> ECCurve.Fp(p, <span class="comment">// q</span>
                a, <span class="comment">// a</span>
                b); <span class="comment">// b</span>
        G = curve.createPoint(xg, yg);
    }

}</code></pre>
